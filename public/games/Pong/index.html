<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pong vs AI</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      background: #0a0f1a;
      color: #e8ecf4;
      font-family: "Courier New", monospace;
    }
    .layout {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
    }
    #container { position: relative; }
    #game {
      background: #111725;
      border: 1px solid #1f2b3d;
      display: block;
    }
    #info {
      max-width: 240px;
      text-align: left;
      font-size: 14px;
      line-height: 1.5;
      color: #d6deff;
      text-shadow: 0 0 6px rgba(255,255,255,0.2);
    }
    #score {
      position: absolute;
      top: 8px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 18px;
      user-select: none;
      pointer-events: none;
    }
    #menu-link {
      display: inline-block;
      margin-top: 12px;
      padding: 8px 12px;
      background: #7dd6ff;
      color: #0a0f1a;
      border-radius: 6px;
      text-decoration: none;
      font-weight: bold;
      box-shadow: 0 0 10px rgba(125,214,255,0.4);
    }
    #stats {
      margin-top: 12px;
      padding: 10px;
      border: 1px solid #1f2b3d;
      border-radius: 8px;
      background: #0f1626;
    }
    #stats .row { font-weight: bold; letter-spacing: 0.5px; margin-bottom: 6px; }
    #leaderboard {
      margin-top: 12px;
      padding: 10px;
      border: 1px solid #1f2b3d;
      border-radius: 8px;
      background: #0f1626;
    }
    #leaderboard .label {
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing: 1px;
      color: #9fb0d8;
      margin-bottom: 6px;
    }
    #leaderboard-list { margin: 0; padding-left: 18px; }
    #leaderboard-list li { margin-bottom: 4px; }
    #leaderboard-list li.empty {
      list-style: none;
      padding-left: 0;
      color: #9fb0d8;
    }
  </style>
</head>
<body>
  <div class="layout">
    <div id="container">
      <canvas id="game" width="640" height="360"></canvas>
      <div id="score">0 - 0</div>
    </div>
    <div id="info">
      Player moves left paddle with W/S keys. Right paddle is an AI that chases the ball with a slight delay. First to keep the ball in play scores when the opponent misses; ball resets center each point.<br>
      Project of CCIS students
      <div id="stats">
        <div class="row">Your score: <span id="player-score">0</span></div>
        <div class="row">Best: <span id="best">0</span></div>
        <div class="row">Race to 5 points per match.</div>
      </div>
      <div id="leaderboard">
        <div class="label">Leaderboard</div>
        <ol id="leaderboard-list"></ol>
      </div>
    </div>
  </div>

  <script src="../leaderboard.js"></script>
  <script>
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");
    const scoreEl = document.getElementById("score");
    const playerScoreEl = document.getElementById("player-score");
    const bestEl = document.getElementById("best");
    const leaderboardListEl = document.getElementById("leaderboard-list");
    const keys = { w: false, s: false };

    const leaderboard = createLeaderboard({
      storageKey: "pongLeaderboard",
      nameKey: "pongPlayerName",
      listElement: leaderboardListEl
    });
    const maxPoints = 5;

    const paddleH = 70, paddleW = 12;
    const player = { x: 20, y: canvas.height / 2 - paddleH / 2, speed: 260 };
    const ai = { x: canvas.width - 32, y: canvas.height / 2 - paddleH / 2, speed: 240 };
    const ball = { x: canvas.width / 2, y: canvas.height / 2, r: 7, vx: 220, vy: 160 };
    const score = { player: 0, ai: 0 };
    let matchOver = false;

    function updateHud(renderBoard = false) {
      scoreEl.textContent = `${score.player} - ${score.ai}`;
      playerScoreEl.textContent = score.player;
      bestEl.textContent = leaderboard.format(leaderboard.best());
      if (renderBoard) leaderboard.render();
    }

    function resetScores() {
      score.player = 0;
      score.ai = 0;
      updateHud();
    }

    function recordRun() {
      leaderboard.record(score.player);
      updateHud(true);
    }

    function awardPoint(side) {
      if (side === "ai") {
        score.ai += 1;
        resetBall(1);
      } else {
        score.player += 1;
        resetBall(-1);
      }
      updateHud();
      if (score.player >= maxPoints || score.ai >= maxPoints) {
        recordRun();
        resetScores();
        resetBall();
      }
    }

    document.addEventListener("keydown", e => {
      if (e.code === "KeyW") keys.w = true;
      if (e.code === "KeyS") keys.s = true;
    });
    document.addEventListener("keyup", e => {
      if (e.code === "KeyW") keys.w = false;
      if (e.code === "KeyS") keys.s = false;
    });

    function resetBall(direction = Math.random() > 0.5 ? 1 : -1) {
      ball.x = canvas.width / 2;
      ball.y = canvas.height / 2;
      ball.vx = 220 * direction;
      ball.vy = (Math.random() * 2 - 1) * 160;
    }

    function clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }

    function update(dt) {
      // Player
      const dir = (keys.w ? -1 : 0) + (keys.s ? 1 : 0);
      player.y = clamp(player.y + dir * player.speed * dt, 0, canvas.height - paddleH);

      // AI follows ball with lag
      const target = ball.y - paddleH / 2;
      if (target > ai.y + 8) ai.y += ai.speed * dt;
      else if (target < ai.y - 8) ai.y -= ai.speed * dt;
      ai.y = clamp(ai.y, 0, canvas.height - paddleH);

      // Ball
      ball.x += ball.vx * dt;
      ball.y += ball.vy * dt;

      if (ball.y - ball.r < 0 || ball.y + ball.r > canvas.height) ball.vy *= -1;

      // Collisions
      function hitPaddle(px, py) {
        return ball.x - ball.r < px + paddleW && ball.x + ball.r > px &&
               ball.y + ball.r > py && ball.y - ball.r < py + paddleH;
      }
      if (ball.vx < 0 && hitPaddle(player.x, player.y)) {
        ball.vx = Math.abs(ball.vx) * 1.03;
        const offset = (ball.y - (player.y + paddleH / 2)) / (paddleH / 2);
        ball.vy = offset * 200;
      }
      if (ball.vx > 0 && hitPaddle(ai.x, ai.y)) {
        ball.vx = -Math.abs(ball.vx) * 1.03;
        const offset = (ball.y - (ai.y + paddleH / 2)) / (paddleH / 2);
        ball.vy = offset * 200;
      }

      // Scoring
      if (ball.x < 0) {
        awardPoint("ai");
      } else if (ball.x > canvas.width) {
        awardPoint("player");
      }
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "#0f1a2b";
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      ctx.strokeStyle = "#1f375b";
      ctx.setLineDash([6, 6]);
      ctx.beginPath();
      ctx.moveTo(canvas.width / 2, 0);
      ctx.lineTo(canvas.width / 2, canvas.height);
      ctx.stroke();
      ctx.setLineDash([]);

      ctx.fillStyle = "#ffffff";
      ctx.fillRect(player.x, player.y, paddleW, paddleH);
      ctx.fillRect(ai.x, ai.y, paddleW, paddleH);

      ctx.beginPath();
      ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI * 2);
      ctx.fill();
    }

    let last = 0;
    function loop(ts) {
      if (!last) last = ts;
      const dt = Math.min((ts - last) / 1000, 0.05);
      last = ts;
      update(dt);
      draw();
      requestAnimationFrame(loop);
    }

    leaderboard.load();
    leaderboard.render();
    updateHud(true);
    resetBall();
    requestAnimationFrame(loop);
  </script>
</body>
</html>
